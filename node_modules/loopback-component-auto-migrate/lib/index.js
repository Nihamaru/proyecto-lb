(function() {
  'use strict';
  var debug, isString, loadCfgSync, path;

  require('./register-config-file-format');

  debug = require('debug')('loopback:component:autoMigrate:main');

  path = require('path');

  isString = require('util-ex/lib/is/type/string');

  loadCfgSync = (require('load-config-file')).loadSync;

  module.exports = function(app, options) {
    var autoMigrate, autoMigrateDone, loopback, loopbackMajor, migration, raiseError, vModels;
    debug('initializing component');
    if (app.get('loopback-component-auto-migrate-status')) {
      debug('already migrating');
      return;
    }
    loopback = app.loopback;
    loopbackMajor = loopback && loopback.version && loopback.version.split('.')[0] || 1;
    if (loopbackMajor < 2) {
      throw new Error('loopback-component-auto-migrate requires loopback 2.0 or newer');
    }
    if (!options || options.enabled !== false) {
      migration = (options && options.migration) || 'auto-update';
      autoMigrate = require('./' + migration);
      raiseError = options && options.migration;
      app.set('loopback-component-auto-migrate-status', 'loaded');
      vModels = options && options.models;
      if (isString(vModels)) {
        // a config file location instead of passing all list inside 'component-config.json'
        options.models = loadCfgSync(path.resolve(vModels));
      }
      autoMigrateDone = autoMigrate(app, options).asCallback(function(err) {
        if (err) {
          app.set('loopback-component-auto-migrate-error', err);
          app.set('loopback-component-auto-migrate-status', 'failed');
          debug(migration + ' failed: %O', err);
          if (raiseError) {
            throw err;
          }
        } else {
          return app.set('loopback-component-auto-migrate-status', 'done');
        }
      });
      app.set('loopback-component-auto-migrate-done', autoMigrateDone); // set the `done` promise of the `autoMigrate()` call
      return autoMigrateDone;
    } else {
      return debug('component not enabled');
    }
  };

}).call(this);

//# sourceMappingURL=index.js.map
